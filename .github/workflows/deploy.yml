name: Deploy Detection Rules

on:
  push:
    branches: [ main, 'feature/**' ]  # Allow feature branches
    paths:
      - 'organizations/org*/env/**'
      - 'infra/**'
      - 'organizations/org*/kql/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      skip_validation:
        description: 'Skip validation steps (for testing)'
        required: false
        default: false
        type: boolean
      force_deploy_all:
        description: 'Force deploy all rules (ignore changes)'
        required: false
        default: false
        type: boolean
      target_branch:
        description: 'Branch to deploy from (for manual triggers)'
        required: false
        default: 'main'
        type: string

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

jobs:
  detect-deployment-needs:
    runs-on: ubuntu-latest
    outputs:
      needs-deployment: ${{ steps.check-deployment-needs.outputs.needs-deployment }}
      changed-files: ${{ steps.check-deployment-needs.outputs.changed-files }}
    
    steps:
    - name: Debug - Workflow Started
      run: |
        echo "üéâ DEPLOYMENT WORKFLOW TRIGGERED!"
        echo "Event: ${{ github.event_name }}"
        echo "Action: ${{ github.event.action }}"
        echo "Ref: ${{ github.ref }}"
        echo "Base: ${{ github.event.pull_request.base.ref }}"
        echo "Head: ${{ github.event.pull_request.head.ref }}"
        echo "Target branch: ${{ github.event.inputs.target_branch }}"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo ""
        echo "üìã Deployment Plan:"
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "  ‚úÖ Main branch push - will deploy to PROD only"
        elif [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
          echo "  ‚úÖ Feature branch push - will deploy to DEV only"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "  ‚úÖ Pull request - will deploy to DEV only"
        else
          echo "  ‚ùì Unknown trigger - check conditions"
        fi
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need at least 2 commits to detect changes
    
    - name: Debug - Workflow Trigger Info
      run: |
        echo "=== WORKFLOW DEBUG INFO ==="
        echo "Event name: ${{ github.event_name }}"
        echo "Event action: ${{ github.event.action }}"
        echo "Base ref: ${{ github.event.pull_request.base.ref }}"
        echo "Head ref: ${{ github.event.pull_request.head.ref }}"
        echo "Changed files:"
        git diff --name-only origin/main...HEAD || echo "No changes detected"
        echo "=== END DEBUG INFO ==="
    
    - name: Debug file structure (detect-deployment-needs)
      run: |
        echo "=== DEBUG: detect-deployment-needs job ==="
        echo "Current directory: $(pwd)"
        echo "Listing files:"
        ls -la
        echo "Listing env directory:"
        ls -la env/ || echo "env directory not found"
        echo "Listing infra directory:"
        ls -la infra/ || echo "infra directory not found"
        echo "=== END DEBUG ==="
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Check deployment needs
      id: check-deployment-needs
      run: |
        echo "Checking if deployment is needed..."
        
        # For workflow_dispatch with force_deploy_all, always deploy
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_deploy_all }}" == "true" ]; then
          echo "Force deploy all rules requested"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check for changes in relevant paths
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "Manual workflow dispatch - checking for changes"
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(env/|infra/|kql/)" || true)
        elif [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "Pull request - checking for changes against base branch"
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E "(env/|infra/|kql/)" || true)
        else
          echo "Detecting changed files..."
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(env/|infra/|kql/)" || true)
        fi
        
        # Check if any rules are missing from Sentinel
        echo "Checking for missing rules in Sentinel..."
        DEPLOYED_RULES=$(az sentinel alert-rule list \
          --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
          --workspace-name ${{ secrets.SENTINEL_WS_DEV }} \
          --output json | jq -r '.[].displayName' 2>/dev/null || echo "")
        
        echo "Deployed rules: $DEPLOYED_RULES"
        
        # For pull requests, always deploy since we know there are changes
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "Pull request detected - will deploy to dev for testing"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # For feature branch pushes, always deploy to dev for testing
        if [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
          echo "Feature branch detected - will deploy to dev for testing"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Output changed files for other jobs to use (properly escaped)
        echo "changed-files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Check for changes first, regardless of branch
        if [ -n "$CHANGED_FILES" ]; then
          echo "Changes detected in: $CHANGED_FILES"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
        else
          echo "No relevant changes detected"
          echo "needs-deployment=false" >> $GITHUB_OUTPUT
        fi

  build-validate:
    runs-on: ubuntu-latest
    needs: detect-deployment-needs
    if: ${{ (needs.detect-deployment-needs.outputs.needs-deployment == 'true') && (!inputs.skip_validation || github.event_name != 'workflow_dispatch') }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Debug file structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Listing files:"
        ls -la
        echo "Listing env directory:"
        ls -la env/ || echo "env directory not found"
        echo "Listing infra directory:"
        ls -la infra/ || echo "infra directory not found"
    
    - name: Validate JSON rule configurations
      run: |
        echo "üîç Validating JSON rule configurations..."
        
        # Find all rules JSON files
        JSON_FILES=$(find organizations/*/env -name "rules-*.json" 2>/dev/null || true)
        
        if [ -z "$JSON_FILES" ]; then
          echo "‚ö†Ô∏è No JSON rule files found"
        else
          echo "Found JSON files:"
          echo "$JSON_FILES"
          
          # Validate each JSON file
          for json_file in $JSON_FILES; do
            echo "  üìÑ Validating $json_file..."
            
            # Test JSON syntax
            if ! jq empty "$json_file" 2>/dev/null; then
              echo "  ‚ùå Invalid JSON syntax in $json_file"
              exit 1
            fi
            
            # Check that referenced KQL files exist
            kql_files=$(jq -r '.[].kqlFile // empty' "$json_file" 2>/dev/null || true)
            if [ -n "$kql_files" ]; then
              json_dir=$(dirname "$json_file")
              env_name=$(basename "$json_file" | sed 's/rules-\(.*\)\.json/\1/')
              kql_dir="$json_dir/../kql/$env_name"
              
              echo "$kql_files" | while read -r kql_file; do
                if [ -n "$kql_file" ] && [ "$kql_file" != "null" ]; then
                  kql_path="$kql_dir/$kql_file"
                  if [ ! -f "$kql_path" ]; then
                    echo "  ‚ùå Missing KQL file: $kql_path (referenced in $json_file)"
                    exit 1
                  else
                    echo "    ‚úÖ KQL file exists: $kql_path"
                  fi
                fi
              done
            fi
            
            echo "  ‚úÖ $json_file is valid"
          done
        fi
        
        echo "‚úÖ JSON rule configurations validated successfully"
    
    - name: Validate Bicep templates (static)
      run: |
        echo "Validating Bicep templates (static checks)..."
        
        # Get changed files from the detect-deployment-needs job
        CHANGED_FILES="${{ needs.detect-deployment-needs.outputs.changed-files }}"
        echo "Changed files: $CHANGED_FILES"
        
        # Validate all Bicep templates using configuration
        pwsh -File scripts/validate-bicep.ps1
        
        # Validate KQL files if any were changed
        if [[ "$CHANGED_FILES" == *"org*/kql/"* ]]; then
          echo "KQL files changed - validating syntax..."
          # List changed KQL files for debugging
          echo "$CHANGED_FILES" | grep "org.*/kql/" || echo "No KQL files in changed files list"
        fi
        
        echo "‚úÖ Bicep templates validated successfully"
    


  deploy-dev:
    needs: [detect-deployment-needs, build-validate]
    runs-on: ubuntu-latest
    if: |
      (needs.detect-deployment-needs.outputs.needs-deployment == 'true') && (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/feature/')) || 
        (github.event_name == 'pull_request') || 
        (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev')
      )
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.target_branch || github.ref }}
    
    - name: Debug - Deployment Info
      run: |
        echo "=== DEPLOYMENT DEBUG INFO ==="
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Target branch: ${{ github.event.inputs.target_branch || github.ref }}"
        echo "Environment: dev"
        echo "Needs deployment: ${{ needs.detect-deployment-needs.outputs.needs-deployment }}"
        echo "=== END DEBUG INFO ==="
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Deploy All Organizations to Dev
      run: |
        echo "Deploying all organizations to Dev environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          # Deploy using the dedicated deployment script
          pwsh -File scripts/deploy-organizations.ps1 -Environment 'dev'
        else
          echo "No deployment needed - skipping"
        fi
    
    - name: Verify deployment
      run: |
        echo "Verifying Dev deployment..."
        # List deployed rules
        az sentinel alert-rule list \
          --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
          --workspace-name ${{ secrets.SENTINEL_WS_DEV }} \
          --query '[].{Name: displayName, Enabled: enabled, Severity: severity}' \
          --output table

  deploy-prod:
    needs: [detect-deployment-needs, build-validate]
    runs-on: ubuntu-latest
    if: |
      (needs.detect-deployment-needs.outputs.needs-deployment == 'true') && (
        (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
        (github.event_name == 'workflow_dispatch' && inputs.environment == 'prod')
      )
    environment: sentinel-prod
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Deploy All Organizations to Prod
      run: |
        echo "Deploying all organizations to Production environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          # Deploy using the dedicated deployment script
          pwsh -File scripts/deploy-organizations.ps1 -Environment 'prod'
        else
          echo "No deployment needed - skipping"
        fi
    
    - name: Verify production deployment
      run: |
        echo "Verifying Production deployment..."
        # List deployed rules
        az sentinel alert-rule list \
          --resource-group ${{ secrets.SENTINEL_RG_PROD }} \
          --workspace-name ${{ secrets.SENTINEL_WS_PROD }} \
          --query '[].{Name: displayName, Enabled: enabled, Severity: severity}' \
          --output table
    
    - name: Post-deployment validation
      run: |
        echo "Running post-deployment validation..."
        # Add any post-deployment checks here
        # e.g., verify rules are enabled, check incident configuration
        echo "‚úÖ Post-deployment validation completed"




