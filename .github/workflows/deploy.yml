name: Deploy Detection Rules

on:
  push:
    branches: [ main ]
    paths:
      - 'env/**'
      - 'infra/**'
      - 'kql/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'env/**'
      - 'infra/**'
      - 'kql/**'
      - '.github/workflows/deploy.yml'
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      skip_validation:
        description: 'Skip validation steps (for testing)'
        required: false
        default: false
        type: boolean
      force_deploy_all:
        description: 'Force deploy all rules (ignore changes)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

jobs:
  detect-deployment-needs:
    runs-on: ubuntu-latest
    outputs:
      needs-deployment: ${{ steps.check-deployment-needs.outputs.needs-deployment }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need at least 2 commits to detect changes
    
    - name: Debug file structure (detect-deployment-needs)
      run: |
        echo "=== DEBUG: detect-deployment-needs job ==="
        echo "Current directory: $(pwd)"
        echo "Listing files:"
        ls -la
        echo "Listing env directory:"
        ls -la env/ || echo "env directory not found"
        echo "Listing infra directory:"
        ls -la infra/ || echo "infra directory not found"
        echo "=== END DEBUG ==="
    
    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az --version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Check deployment needs
      id: check-deployment-needs
      run: |
        echo "Checking if deployment is needed..."
        
        # For workflow_dispatch with force_deploy_all, always deploy
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_deploy_all }}" == "true" ]; then
          echo "Force deploy all rules requested"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check for changes in relevant paths
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "Manual workflow dispatch - checking for changes"
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(env/|infra/|kql/)" || true)
        else
          echo "Detecting changed files..."
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(env/|infra/|kql/)" || true)
        fi
        
        # Check if any rules are missing from Sentinel
        echo "Checking for missing rules in Sentinel..."
        DEPLOYED_RULES=$(az sentinel alert-rule list \
          --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
          --workspace-name ${{ secrets.SENTINEL_WS_DEV }} \
          --output json | jq -r '.[].displayName' 2>/dev/null || echo "")
        
        echo "Deployed rules: $DEPLOYED_RULES"
        
        # Check if our expected rules are missing
        EXPECTED_RULES="[DEV] [ORG] – Suspicious PowerShell (EncodedCommand) [DEV] [ORG] – Suspicious Login Attempts [DEV] [ORG] – Admin Account Anomaly Detection"
        MISSING_RULES=""
        
        for rule in $EXPECTED_RULES; do
          if ! echo "$DEPLOYED_RULES" | grep -q "$rule"; then
            echo "Missing rule: $rule"
            MISSING_RULES="$MISSING_RULES $rule"
          fi
        done
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "Changes detected in: $CHANGED_FILES"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
        elif [ -n "$MISSING_RULES" ]; then
          echo "Missing rules detected: $MISSING_RULES"
          echo "needs-deployment=true" >> $GITHUB_OUTPUT
        else
          echo "No relevant changes or missing rules detected"
          echo "needs-deployment=false" >> $GITHUB_OUTPUT
        fi

  build-validate:
    runs-on: ubuntu-latest
    needs: detect-deployment-needs
    if: ${{ !inputs.skip_validation || github.event_name != 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az --version
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Debug file structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Listing files:"
        ls -la
        echo "Listing env directory:"
        ls -la env/ || echo "env directory not found"
        echo "Listing infra directory:"
        ls -la infra/ || echo "infra directory not found"
    
    - name: Validate Bicep templates (static)
      run: |
        echo "Validating Bicep templates (static checks)..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          echo "Building main templates..."
          az bicep build --file infra/sentinel-rules.bicep
          az bicep build --file infra/modules/scheduledRule.bicep
          az bicep build --file env/deploy-dev.bicep
          az bicep build --file env/deploy-prod.bicep
          echo "✅ Bicep templates validated successfully"
        else
          echo "No deployment needed - skipping validation"
        fi
    
    - name: Validate deployment (Dev)
      run: |
        echo "Validating deployment against Dev environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          az deployment group validate \
            --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
            --template-file env/deploy-dev.bicep \
            --parameters env/params/dev.jsonc
          echo "✅ Dev deployment validation completed successfully"
        else
          echo "No deployment needed - skipping validation"
        fi
    
    - name: What-if deployment (Dev)
      run: |
        echo "Running what-if deployment for Dev environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          az deployment group what-if \
            --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
            --template-file env/deploy-dev.bicep \
            --parameters env/params/dev.jsonc \
            --no-pretty-print --only-show-errors
          echo "✅ What-if deployment completed successfully"
        else
          echo "No deployment needed - skipping what-if"
        fi

  deploy-dev:
    needs: [detect-deployment-needs, build-validate]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      (github.event_name == 'pull_request') || 
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az --version
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Deploy to Dev
      run: |
        echo "Deploying to Dev environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          az deployment group create \
            --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
            --template-file env/deploy-dev.bicep \
            --parameters env/params/dev.jsonc \
            --verbose
          echo "✅ Dev deployment completed successfully"
        else
          echo "No deployment needed - skipping"
        fi
    
    - name: Verify deployment
      run: |
        echo "Verifying Dev deployment..."
        # List deployed rules
        az sentinel alert-rule list \
          --resource-group ${{ secrets.SENTINEL_RG_DEV }} \
          --workspace-name ${{ secrets.SENTINEL_WS_DEV }} \
          --query '[].{Name: displayName, Enabled: enabled, Severity: severity}' \
          --output table

  deploy-prod:
    needs: [detect-deployment-needs, build-validate, deploy-dev]
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'prod')
    environment: sentinel-prod
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az --version
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Validate deployment (Prod)
      run: |
        echo "Validating deployment against Prod environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          az deployment group validate \
            --resource-group ${{ secrets.SENTINEL_RG_PROD }} \
            --template-file env/deploy-prod.bicep \
            --parameters env/params/prod.jsonc
          echo "✅ Prod deployment validation completed successfully"
        else
          echo "No deployment needed - skipping validation"
        fi
    
    - name: What-if deployment (Prod)
      run: |
        echo "Running what-if deployment for Prod environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          az deployment group what-if \
            --resource-group ${{ secrets.SENTINEL_RG_PROD }} \
            --template-file env/deploy-prod.bicep \
            --parameters env/params/prod.jsonc \
            --no-pretty-print --only-show-errors
          echo "✅ What-if deployment completed successfully"
        else
          echo "No deployment needed - skipping what-if"
        fi
    
    - name: Deploy to Prod
      run: |
        echo "Deploying to Production environment..."
        if [ "${{ needs.detect-deployment-needs.outputs.needs-deployment }}" == "true" ]; then
          az deployment group create \
            --resource-group ${{ secrets.SENTINEL_WS_PROD }} \
            --template-file env/deploy-prod.bicep \
            --parameters env/params/prod.jsonc \
            --verbose
          echo "✅ Production deployment completed successfully"
        else
          echo "No deployment needed - skipping"
        fi
    
    - name: Verify production deployment
      run: |
        echo "Verifying Production deployment..."
        # List deployed rules
        az sentinel alert-rule list \
          --resource-group ${{ secrets.SENTINEL_WS_PROD }} \
          --workspace-name ${{ secrets.SENTINEL_RG_PROD }} \
          --query '[].{Name: displayName, Enabled: enabled, Severity: severity}' \
          --output table
    
    - name: Post-deployment validation
      run: |
        echo "Running post-deployment validation..."
        # Add any post-deployment checks here
        # e.g., verify rules are enabled, check incident configuration
        echo "✅ Post-deployment validation completed"
